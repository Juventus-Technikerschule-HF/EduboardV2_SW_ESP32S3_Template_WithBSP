/********************************************************************************************* */
//    Eduboard2 ESP32-S3 Template with BSP
//    Author: Martin Burger
//    Juventus Technikerschule
//    Version: 1.0.0
//    
//    This is the ideal starting point for a new Project. BSP for most of the Eduboard2
//    Hardware is included under components/eduboard2.
//    Hardware support can be activated/deactivated in components/eduboard2/eduboard2_config.h
/********************************************************************************************* */
#include "eduboard2.h"
#include "memon.h"

#include "math.h"

#define TAG "TEMPLATE"

uint8_t sinedata[] = {0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,};

#define UPDATETIME_MS 100

void dacCallbackFunction() {
    dac_load_stream_data(sinedata, sinedata);
}

void templateTask(void* param) {
    //Init stuff here
    vTaskDelay(100);
    dac_set_config(DAC_A, DAC_GAIN_1, true);
    dac_set_config(DAC_B, DAC_GAIN_1, true);
    dac_update();
    dac_set_stream_callback(&dacCallbackFunction);
    dac_load_stream_data(sinedata, sinedata);
    for(;;) {
        uint32_t adcValue = adc_get_raw(AN0_CHANNEL);
        uint32_t adcVoltage_mv = adc_get_voltage_mv(AN0_CHANNEL);
        ESP_LOGI(TAG, "ADC: %i - Voltage: %imV", (int)(adcValue), (int)(adcVoltage_mv));
        // task main loop
        if(button_get_state(SW0, true) == SHORT_PRESSED) {
            led_toggle(LED0);
        }
        led_toggle(LED7);
        // delay
        vTaskDelay(UPDATETIME_MS/portTICK_PERIOD_MS);
    }
}

void app_main()
{
    //Initialize Eduboard2 BSP
    eduboard2_init();
    
    //Create templateTask
    xTaskCreate(templateTask,   //Subroutine
                "testTask",     //Name
                2*2048,         //Stacksize
                NULL,           //Parameters
                10,             //Priority
                NULL);          //Taskhandle
    for(;;) {
        vTaskDelay(2000/portTICK_PERIOD_MS);
        ESP_LOGI(TAG, "Hello Eduboard");
    }
}